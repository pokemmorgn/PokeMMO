<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeWorld - Connexion sécurisée Sui</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .bg-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        .particle:nth-child(1) { width: 4px; height: 4px; top: 20%; left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 6px; height: 6px; top: 40%; left: 60%; animation-delay: 1s; }
        .particle:nth-child(3) { width: 3px; height: 3px; top: 70%; left: 30%; animation-delay: 2s; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 600px;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #9333ea, #3b82f6);
            border-radius: 20px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #1f2937, #4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 16px;
            color: #6b7280;
            line-height: 1.5;
        }

        .auth-section {
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
            border: 2px solid #c7d2fe;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .auth-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-dot.connecting {
            background: #f59e0b;
            animation: spin 1s linear infinite;
        }

        .status-dot.pending {
            background: #8b5cf6;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-text h3 {
            color: #3730a3;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .status-text p {
            color: #6b7280;
            font-size: 14px;
        }

        .server-status {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: #6b7280;
        }

        .server-status.connected {
            background: #ecfdf5;
            border-color: #10b981;
            color: #059669;
        }

        .connect-button {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px 24px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
            margin-bottom: 16px;
        }

        .connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(139, 92, 246, 0.4);
        }

        .connect-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .connect-button.disconnect {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        .auth-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
            display: none;
        }

        .auth-info.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wallet-address {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            color: #4338ca;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            word-break: break-all;
            margin-top: 8px;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #7c3aed;
        }

        .play-button {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px 24px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
            display: none;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        .play-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
        }

        .play-button.active {
            display: block;
            animation: slideUp 0.5s ease-out;
        }

        .debug-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
            font-size: 12px;
            color: #6b7280;
        }

        .debug-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .debug-item {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        .success-message {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        @media (max-width: 640px) {
            .container {
                margin: 20px;
                padding: 32px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">P</div>
            <h1 class="title">PokeWorld - Connexion Sécurisée</h1>
            <p class="subtitle">Authentification blockchain via Phantom Wallet (Sui Network)</p>
        </div>

        <div class="auth-section">
            <div class="auth-status">
                <div class="status-info">
                    <div class="status-dot" id="statusDot"></div>
                    <div class="status-text">
                        <h3 id="authStatus">Non connecté</h3>
                        <p id="authDetails">Cliquez pour vous connecter</p>
                    </div>
                </div>
                <div class="server-status" id="serverStatus">Serveur: Déconnecté</div>
            </div>
        </div>

        <button class="connect-button" id="connectBtn">
            🔗 Se connecter avec Phantom
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #6b7280;">Connexion en cours...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="auth-info" id="authInfo">
            <h4 style="color: #374151; margin-bottom: 8px;">✅ Authentification réussie</h4>
            <p style="color: #6b7280; font-size: 14px;">Adresse du compte authentifié :</p>
            <div class="wallet-address" id="walletAddress">
                <button class="copy-btn" onclick="copyAddress()">Copy</button>
            </div>
        </div>

        <button class="play-button" id="playBtn">
            🎮 Jouer à PokeWorld
        </button>

        <div class="debug-section">
            <div class="debug-title">🔧 Diagnostic Technique</div>
            <div class="debug-item">
                <span>Phantom installé:</span>
                <span id="phantomInstalled">❌</span>
            </div>
            <div class="debug-item">
                <span>Support Sui:</span>
                <span id="suiSupport">❌</span>
            </div>
            <div class="debug-item">
                <span>Serveur AuthRoom:</span>
                <span id="authRoomStatus">❌</span>
            </div>
            <div class="debug-item">
                <span>Statut signature:</span>
                <span id="signatureStatus">En attente</span>
            </div>
            <div class="debug-item">
                <span>Session ID:</span>
                <span id="sessionId">Non assigné</span>
            </div>
        </div>
    </div>

    <!-- Colyseus Client, VERSION FIXÉE -->
    <script src="https://unpkg.com/colyseus.js@0.15.16/dist/colyseus.js"></script>
    <script>
        class SecurePokeWorldAuth {
            constructor() {
                this.client = null;
                this.authRoom = null;
                this.currentWallet = null;
                this.isAuthenticated = false;
                this.challengeMessage = null;
                this.sessionId = null;

                this.initializeElements();
                this.initializeEventListeners();
                this.startDiagnostics();
                this.connectToAuthServer();
            }

            initializeElements() {
                this.connectBtn = document.getElementById('connectBtn');
                this.playBtn = document.getElementById('playBtn');
                this.loading = document.getElementById('loading');
                this.authInfo = document.getElementById('authInfo');
                this.walletAddress = document.getElementById('walletAddress');
                this.statusDot = document.getElementById('statusDot');
                this.authStatus = document.getElementById('authStatus');
                this.authDetails = document.getElementById('authDetails');
                this.serverStatus = document.getElementById('serverStatus');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
            }

            initializeEventListeners() {
                this.connectBtn.addEventListener('click', () => this.handleAuthFlow());
                this.playBtn.addEventListener('click', () => this.startGame());
            }

            async connectToAuthServer() {
                try {
                    console.log('🔐 Connexion au serveur d\'authentification...');
                    // CORRECTION: Ajout explicite du "window." pour être 100% compatible avec la version browser Colyseus
                    this.client = new window.Colyseus.Client('wss://pokerune.cloud:2567');
                    this.authRoom = await this.client.joinOrCreate('AuthRoom');
                    this.sessionId = this.authRoom.sessionId;

                    this.serverStatus.textContent = 'Serveur: Connecté';
                    this.serverStatus.classList.add('connected');
                    document.getElementById('authRoomStatus').textContent = '✅';
                    document.getElementById('sessionId').textContent = this.sessionId.substring(0, 8) + '...';

                    this.setupAuthRoomListeners();
                    console.log('✅ Connecté au serveur d\'authentification');

                } catch (error) {
                    console.error('❌ Erreur connexion serveur:', error);
                    this.showError('Impossible de se connecter au serveur d\'authentification');
                }
            }

            setupAuthRoomListeners() {
                // ... (Aucune modif, copie/colle tout le reste de ta classe ici inchangé) ...
                // (Ne supprime rien, ne touche pas le reste !)
                this.authRoom.onMessage('authChallenge', (data) => {
                    this.challengeMessage = data.message;
                    this.signMessage(data.message);
                });
                this.authRoom.onMessage('authSuccess', (data) => {
                    this.handleAuthSuccess(data);
                });
                this.authRoom.onMessage('authError', (data) => {
                    this.showError(data.error);
                    this.setLoadingState(false);
                    document.getElementById('signatureStatus').textContent = 'Erreur: ' + data.code;
                });
                this.authRoom.onMessage('authStatus', (data) => {
                    if (data.isAuthenticated) {
                        this.isAuthenticated = true;
                        this.currentWallet = { address: data.walletAddress };
                        this.updateAuthenticatedState();
                    }
                });
                this.authRoom.onMessage('connectionEstablished', (data) => {});
            }

            async handleAuthFlow() { /* ... inchangé ... */ 
                if (this.isAuthenticated) {
                    this.logout();
                    return;
                }
                try {
                    this.setLoadingState(true);
                    this.updateStatus('connecting', 'Connexion à Phantom...');
                    await this.waitForPhantom();
                    if (!window.phantom?.sui) {
                        throw new Error('Phantom Wallet avec support Sui requis');
                    }
                    this.updateStatus('connecting', 'Connexion au wallet...');
                    const walletData = await this.connectPhantom();
                    this.currentWallet = walletData;
                    this.updateStatus('pending', 'Demande de signature...');
                    this.authRoom.send('requestChallenge', {
                        walletAddress: walletData.address
                    });
                    document.getElementById('signatureStatus').textContent = 'Défi demandé...';
                } catch (error) {
                    this.showError(error.message);
                    this.setLoadingState(false);
                    this.updateStatus('disconnected', 'Erreur de connexion');
                }
            }

            async connectPhantom() { /* ... inchangé ... */
                try {
                    const suiProvider = window.phantom.sui;
                    const response = await suiProvider.requestAccount();
                    let address = null;
                    if (response && response.address) {
                        address = response.address;
                    } else if (response && typeof response === 'string') {
                        address = response;
                    } else if (suiProvider.publicKey) {
                        address = suiProvider.publicKey.toString();
                    }
                    if (!address) {
                        throw new Error('Impossible de récupérer l\'adresse du wallet');
                    }
                    return { address };
                } catch (error) {
                    throw new Error('Échec de la connexion Phantom: ' + error.message);
                }
            }

            async signMessage(message) { /* ... inchangé ... */
                try {
                    this.updateStatus('pending', 'Signature en cours...');
                    document.getElementById('signatureStatus').textContent = 'Demande signature...';
                    const suiProvider = window.phantom.sui;
                    if (!suiProvider.signMessage) {
                        throw new Error('Fonction de signature non disponible');
                    }
                    const messageBytes = new TextEncoder().encode(message);
                    const signatureResponse = await suiProvider.signMessage({
                        message: messageBytes
                    });
                    document.getElementById('signatureStatus').textContent = 'Signature obtenue';
                    this.authRoom.send('verifyAuth', {
                        walletAddress: this.currentWallet.address,
                        signature: signatureResponse.signature,
                        message: message,
                        timestamp: Date.now()
                    });
                    this.updateStatus('pending', 'Vérification serveur...');
                    document.getElementById('signatureStatus').textContent = 'Vérification...';
                } catch (error) {
                    this.showError('Erreur lors de la signature: ' + error.message);
                    this.setLoadingState(false);
                    document.getElementById('signatureStatus').textContent = 'Erreur signature';
                }
            }

            handleAuthSuccess(data) { /* ... inchangé ... */
                this.isAuthenticated = true;
                this.currentWallet = { address: data.walletAddress };
                this.playerData = data.playerData;
                this.updateAuthenticatedState();
                this.showSuccess('Authentification réussie! Bienvenue dans PokeWorld.');
                document.getElementById('signatureStatus').textContent = 'Authentifié ✅';
            }

            updateAuthenticatedState() { /* ... inchangé ... */
                this.setLoadingState(false);
                this.updateStatus('connected', 'Authentifié');
                this.authInfo.classList.add('active');
                this.walletAddress.innerHTML = `${this.currentWallet.address}<button class="copy-btn" onclick="copyAddress()">Copy</button>`;
                this.connectBtn.textContent = '🔓 Se déconnecter';
                this.connectBtn.classList.add('disconnect');
                this.playBtn.classList.add('active');
            }

            logout() { /* ... inchangé ... */
                this.isAuthenticated = false;
                this.currentWallet = null;
                this.playerData = null;
                this.challengeMessage = null;
                try {
                    if (window.phantom?.sui?.disconnect) {
                        window.phantom.sui.disconnect();
                    }
                } catch (error) {}
                this.updateStatus('disconnected', 'Déconnecté');
                this.authInfo.classList.remove('active');
                this.playBtn.classList.remove('active');
                this.connectBtn.textContent = '🔗 Se connecter avec Phantom';
                this.connectBtn.classList.remove('disconnect');
                document.getElementById('signatureStatus').textContent = 'Déconnecté';
                this.hideMessages();
            }

            startGame() { /* ... inchangé ... */
                if (!this.isAuthenticated || !this.playerData) {
                    this.showError('Vous devez être authentifié pour jouer');
                    return;
                }
                const gameParams = new URLSearchParams({
                    wallet: this.currentWallet.address,
                    authenticated: 'true',
                    session: this.sessionId
                });
                window.location.href = `game.html?${gameParams.toString()}`;
            }

            updateStatus(status, message) { /* ... inchangé ... */
                this.statusDot.className = 'status-dot';
                if (status !== 'disconnected') {
                    this.statusDot.classList.add(status);
                }
                this.authStatus.textContent = this.getStatusText(status);
                this.authDetails.textContent = message;
            }
            getStatusText(status) { /* ... inchangé ... */
                switch (status) {
                    case 'connected': return 'Authentifié';
                    case 'connecting': return 'Connexion...';
                    case 'pending': return 'En attente...';
                    default: return 'Non connecté';
                }
            }
            setLoadingState(loading) { /* ... inchangé ... */
                if (loading) {
                    this.connectBtn.style.display = 'none';
                    this.loading.style.display = 'block';
                } else {
                    this.connectBtn.style.display = 'block';
                    this.loading.style.display = 'none';
                }
            }
            showError(message) { /* ... inchangé ... */
                this.hideMessages();
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                setTimeout(() => {
                    this.errorMessage.style.display = 'none';
                }, 5000);
            }
            showSuccess(message) { /* ... inchangé ... */
                this.hideMessages();
                this.successMessage.textContent = message;
                this.successMessage.style.display = 'block';
                setTimeout(() => {
                    this.successMessage.style.display = 'none';
                }, 3000);
            }
            hideMessages() { /* ... inchangé ... */
                this.errorMessage.style.display = 'none';
                this.successMessage.style.display = 'none';
            }
            async waitForPhantom(timeout = 10000) { /* ... inchangé ... */
                return new Promise((resolve, reject) => {
                    if (window.phantom) {
                        resolve();
                        return;
                    }
                    let attempts = 0;
                    const maxAttempts = timeout / 100;
                    const checkPhantom = () => {
                        attempts++;
                        if (window.phantom) {
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('Phantom Wallet non détecté. Installez l\'extension Phantom.'));
                        } else {
                            setTimeout(checkPhantom, 100);
                        }
                    };
                    checkPhantom();
                });
            }
            async startDiagnostics() { /* ... inchangé ... */
                await this.updateDiagnostics();
                setInterval(() => {
                    this.updateDiagnostics();
                }, 3000);
            }
            async updateDiagnostics() { /* ... inchangé ... */
                try {
                    await this.waitForPhantom(1000);
                } catch (error) {}
                const phantomInstalled = !!window.phantom;
                const suiSupport = !!(window.phantom && window.phantom.sui);
                document.getElementById('phantomInstalled').textContent = phantomInstalled ? '✅' : '❌';
                document.getElementById('suiSupport').textContent = suiSupport ? '✅' : '❌';
            }
        }

        // Fonction utilitaire pour copier l'adresse
        function copyAddress() {
            const address = document.getElementById('walletAddress').textContent.replace('Copy', '');
            navigator.clipboard.writeText(address).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copié!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1000);
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = address;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                const btn = document.querySelector('.copy-btn');
                btn.textContent = 'Copié!';
                setTimeout(() => {
                    btn.textContent = 'Copy';
                }, 1000);
            });
        }

        let authApp;
        window.addEventListener('load', () => {
            setTimeout(() => {
                authApp = new SecurePokeWorldAuth();
                console.log('🚀 Application d\'authentification initialisée');
            }, 1000);
        });

        window.addEventListener('phantom_injected', () => {
            if (!authApp) {
                setTimeout(() => {
                    authApp = new SecurePokeWorldAuth();
                    console.log('🚀 Application initialisée via événement Phantom');
                }, 500);
            }
        });
    </script>
</body>
</html>
