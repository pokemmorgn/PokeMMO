<script>
window._suiWalletData = null;

// D√©tecter et connecter SUI Wallet
async function connectSuiWallet() {
    // Cherche les wallets compatibles SUI install√©s
    const wallets = window.walletStandard?.getWallets().get() || [];
    if (!wallets.length) {
        alert("Aucun wallet SUI d√©tect√© (Phantom, Suiet, Ethos...)");
        return;
    }

    // Si plusieurs wallets d√©tect√©s, on peut afficher une liste ici (TODO)
    const wallet = wallets[0];
    try {
        await wallet.connect();
    } catch (e) {
        alert("Connexion au wallet refus√©e !");
        return;
    }

    const account = wallet.accounts[0];
    const address = account.address;

    // Affichage infos UI
    document.getElementById('walletInfo').style.display = 'block';
    document.getElementById('walletAddress').innerHTML =
        address + ' <button class="copy-btn" onclick="copyAddress()">Copy</button>';
    document.getElementById('accountDetails').textContent =
        " (" + (wallet.name || "Wallet") + " - " + address.slice(0, 8) + "‚Ä¶)";
    document.getElementById('walletStatus').textContent = '‚úÖ Connect√©';
    document.getElementById('connectBtn').textContent = 'üîì D√©connecter';
    document.getElementById('connectBtn').onclick = disconnectWallet;

    window._suiWalletData = { wallet, account, address };
    document.getElementById('playGameBtn').style.display = 'inline-block';
}

// D√©connexion UI (optionnel : wallet.disconnect() si support√©)
function disconnectWallet() {
    window._suiWalletData = null;
    document.getElementById('walletInfo').style.display = 'none';
    document.getElementById('walletStatus').textContent = '';
    document.getElementById('connectBtn').textContent = 'üîó Se connecter √† SUI';
    document.getElementById('connectBtn').onclick = connectSuiWallet;
    document.getElementById('playGameBtn').style.display = 'none';
}

// Copier adresse dans le presse-papiers
function copyAddress() {
    const address = document.getElementById('walletAddress').textContent.replace('Copy', '');
    navigator.clipboard.writeText(address).then(() => {
        const btn = document.querySelector('.copy-btn');
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = 'Copi√©!';
            setTimeout(() => { btn.textContent = originalText; }, 1000);
        }
    });
}

// Lancer authentification Colyseus (avec signature)
async function authenticateAndPlay() {
    const { wallet, address } = window._suiWalletData || {};
    if (!wallet || !address) {
        alert("Connecte ton wallet avant de jouer.");
        return;
    }

    // G√©n√®re un message + signature anti-rejeu
    const message = `PokeWorld Auth ${Date.now()}`;
    const encoded = new TextEncoder().encode(message);
    let signature;
    try {
        const result = await wallet.signMessage({ message: encoded });
        signature = result.signature;
    } catch (e) {
        alert("Signature refus√©e !");
        return;
    }

    // Colyseus AuthRoom (modifie l'URL si besoin)
    const client = new Colyseus.Client("wss://pokerune.cloud/ws");
    const room = await client.joinOrCreate("AuthRoom");
    room.send("authenticate", {
        address,
        signature,
        message,
        walletType: "sui-standard",
        timestamp: Date.now(),
    });

    room.onMessage("authenticated", (data) => {
        if (data.status === "ok") {
            alert("Authentification r√©ussie !");
            window.location.href = "index.html?wallet=" + encodeURIComponent(address);
        } else {
            alert("Erreur d'authentification");
        }
    });

    room.onMessage("error", (error) => {
        alert("Erreur serveur : " + error.reason);
        room.leave();
    });
}

// Bind boutons au chargement du DOM
window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('connectBtn').onclick = connectSuiWallet;
    document.getElementById('playGameBtn').onclick = authenticateAndPlay;
});
</script>
