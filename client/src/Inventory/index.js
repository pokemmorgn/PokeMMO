// Inventory/index.js - Module Inventory Unifi√© pour UIManager
// üéØ 1 SEUL module qui g√®re TOUT : business logic + ic√¥ne + interface
// ‚úÖ MODIFI√â: Auto-enregistrement UIManager pour positionnement intelligent

import { InventorySystem } from './InventorySystem.js';
import { InventoryIcon } from './InventoryIcon.js';
import { InventoryUI } from './InventoryUI.js';

/**
 * Module Inventory Unifi√©
 * Compatible avec UIManager
 * API simple: show(), hide(), setEnabled()
 */
export class InventoryModule {
  constructor(gameRoom, scene) {
    this.gameRoom = gameRoom;
    this.scene = scene;
    
    // === INSTANCES DES COMPOSANTS ===
    this.system = null;
    this.icon = null;
    this.ui = null;
    
    // === √âTAT UIManager ===
    this.uiManagerState = {
      visible: true,        // Ic√¥ne visible par d√©faut
      enabled: true,        // Module activ√©
      initialized: false    // Non encore initialis√©
    };
    
    console.log('üéí [InventoryModule] Instance cr√©√©e');
  }
  
  // === üöÄ INITIALISATION ===
  
  async init() {
    try {
      console.log('üöÄ [InventoryModule] Initialisation...');
      
      // 1. Cr√©er l'UI d'inventaire
      this.ui = new InventoryUI(this.gameRoom);
      
      // 2. Cr√©er l'ic√¥ne d'inventaire  
      this.icon = new InventoryIcon(this.ui);
      await this.icon.init(); // S'assurer que l'ic√¥ne est cr√©√©e
      
      // 3. Cr√©er le syst√®me principal (qui orchestre)
      this.system = new InventorySystem(this.scene, this.gameRoom);
      
      // 4. Connecter les composants
      this.connectComponents();
      
      // ‚úÖ 5. AUTO-ENREGISTREMENT DANS UIMANAGER
      this.registerWithUIManager();
      
      // 6. Appliquer l'√©tat initial
      this.applyUIManagerState();
      
      this.uiManagerState.initialized = true;
      
      console.log('‚úÖ [InventoryModule] Initialis√© avec UIManager');
      return this;
      
    } catch (error) {
      console.error('‚ùå [InventoryModule] Erreur initialisation:', error);
      throw error;
    }
  }
  
  // ‚úÖ NOUVELLE M√âTHODE: Auto-enregistrement UIManager
  registerWithUIManager() {
    console.log('üìç [InventoryModule] Enregistrement dans UIManager...');
    
    // V√©rifier que UIManager existe
    if (!window.uiManager || !window.uiManager.registerIconPosition) {
      console.warn('‚ö†Ô∏è [InventoryModule] UIManager non disponible pour positionnement');
      return;
    }
    
    // V√©rifier que l'ic√¥ne existe
    if (!this.icon || !this.icon.iconElement) {
      console.warn('‚ö†Ô∏è [InventoryModule] IconElement non disponible pour enregistrement');
      return;
    }
    
    // Supprimer tout positionnement manuel existant
    const iconElement = this.icon.iconElement;
    iconElement.style.position = '';
    iconElement.style.right = '';
    iconElement.style.bottom = '';
    iconElement.style.left = '';
    iconElement.style.top = '';
    
    // Enregistrer dans UIManager
    window.uiManager.registerIconPosition('inventory', iconElement, {
      anchor: 'bottom-right',
      order: 0,               // Premi√®re position (plus √† droite)
      group: 'ui-icons',
      spacing: 10,
      size: { width: 70, height: 80 }
    });
    
    console.log('‚úÖ [InventoryModule] Ic√¥ne enregistr√©e dans UIManager (ordre: 0)');
  }
  
  // === üîó CONNEXION DES COMPOSANTS ===
  
  connectComponents() {
    console.log('üîó [InventoryModule] Connexion des composants...');
    
    // Le syst√®me InventorySystem g√®re d√©j√† les connexions
    // entre InventoryIcon et InventoryUI, donc pas grand chose √† faire
    
    // S'assurer que les r√©f√©rences sont correctes
    if (this.system) {
      this.system.inventoryUI = this.ui;
      this.system.inventoryIcon = this.icon;
    }
    
    // Exposer globalement pour compatibilit√©
    window.inventorySystem = this.system;
    window.inventorySystemGlobal = this; // Pour UIManager
    
    console.log('‚úÖ [InventoryModule] Composants connect√©s');
  }
  
  // === üéõÔ∏è M√âTHODES UIMANAGER (INTERFACE PRINCIPALE) ===
  
  /**
   * UIManager appelle cette m√©thode pour afficher le module
   */
  show() {
    console.log('üëÅÔ∏è [InventoryModule] Show appel√©');
    
    this.uiManagerState.visible = true;
    
    // Afficher l'ic√¥ne
    if (this.icon && this.icon.show) {
      this.icon.show();
    }
    
    return true;
  }
  
  /**
   * UIManager appelle cette m√©thode pour cacher le module
   */
  hide() {
    console.log('üëª [InventoryModule] Hide appel√©');
    
    this.uiManagerState.visible = false;
    
    // Cacher l'ic√¥ne
    if (this.icon && this.icon.hide) {
      this.icon.hide();
    }
    
    // Cacher l'interface si ouverte
    if (this.ui && this.ui.isVisible) {
      this.ui.hide();
    }
    
    return true;
  }
  
  /**
   * UIManager appelle cette m√©thode pour activer/d√©sactiver
   */
  setEnabled(enabled) {
    console.log(`üîß [InventoryModule] setEnabled(${enabled})`);
    
    this.uiManagerState.enabled = enabled;
    
    // Appliquer aux composants
    if (this.icon && this.icon.setEnabled) {
      this.icon.setEnabled(enabled);
    }
    
    if (this.ui && this.ui.setEnabled) {
      this.ui.setEnabled(enabled);
    }
    
    return true;
  }
  
  /**
   * UIManager peut appeler cette m√©thode pour obtenir l'√©tat
   */
  getUIManagerState() {
    return {
      ...this.uiManagerState,
      iconVisible: this.icon ? !this.icon.iconElement?.classList.contains('ui-hidden') : false,
      interfaceVisible: this.ui ? this.ui.isVisible : false,
      hasItems: this.ui ? Object.keys(this.ui.inventoryData).length > 0 : false,
      canOpen: this.canOpenInventory()
    };
  }
  
  // === üîß GESTION √âTAT INTERNE ===
  
  applyUIManagerState() {
    if (!this.uiManagerState.initialized) return;
    
    // Appliquer visibilit√©
    if (this.uiManagerState.visible) {
      this.icon?.show?.();
    } else {
      this.icon?.hide?.();
      this.ui?.hide?.();
    }
    
    // Appliquer √©tat enabled
    this.icon?.setEnabled?.(this.uiManagerState.enabled);
    this.ui?.setEnabled?.(this.uiManagerState.enabled);
  }
  
  canOpenInventory() {
    // V√©rifier si on peut ouvrir l'interface
    const blockers = [
      document.querySelector('.quest-dialog-overlay'),
      document.querySelector('#dialogue-box:not([style*="display: none"])'),
      document.querySelector('#team-overlay:not(.hidden)')
    ];
    
    const hasBlocker = blockers.some(el => el !== null);
    const chatFocused = typeof window.isChatFocused === 'function' ? window.isChatFocused() : false;
    
    return !hasBlocker && !chatFocused && this.uiManagerState.enabled;
  }
  
  // === üìä API PUBLIQUE POUR COMPATIBILIT√â ===
  
  /**
   * Ouvrir/fermer l'interface Inventory
   */
  toggle() {
    if (this.ui) {
      this.ui.toggle();
    }
  }
  
  /**
   * Ouvrir l'interface Inventory
   */
  openInventory() {
    if (this.ui && this.canOpenInventory()) {
      this.ui.show();
    }
  }
  
  /**
   * Fermer l'interface Inventory
   */
  closeInventory() {
    if (this.ui) {
      this.ui.hide();
    }
  }
  
  /**
   * Ouvrir l'inventaire √† une poche sp√©cifique
   */
  openToPocket(pocketName) {
    if (this.ui) {
      this.ui.openToPocket(pocketName);
    }
  }
  
  /**
   * V√©rifier si l'inventaire est ouvert
   */
  isInventoryOpen() {
    return this.ui ? this.ui.isVisible : false;
  }
  
  /**
   * Utiliser un objet
   */
  useItem(itemId, context = "field") {
    if (this.system) {
      this.system.useItem(itemId, context);
    }
  }
  
  /**
   * V√©rifier si on a un objet
   */
  hasItem(itemId) {
    return this.system ? this.system.hasItem(itemId) : false;
  }
  
  /**
   * Obtenir la quantit√© d'un objet
   */
  getItemCount(itemId) {
    return this.system ? this.system.getItemCount(itemId) : 0;
  }
  
  /**
   * Demander les donn√©es d'inventaire au serveur
   */
  requestInventoryData() {
    if (this.system) {
      this.system.requestInventoryData();
    }
  }
  
  // === üßπ NETTOYAGE ===
  
  destroy() {
    try {
      console.log('üßπ [InventoryModule] Destruction...');
      
      // D√©truire les composants dans l'ordre inverse
      if (this.system && this.system.destroy) {
        this.system.destroy();
        this.system = null;
      }
      
      if (this.icon && this.icon.destroy) {
        this.icon.destroy();
        this.icon = null;
      }
      
      if (this.ui && this.ui.destroy) {
        this.ui.destroy();
        this.ui = null;
      }
      
      // Reset √©tat
      this.uiManagerState.initialized = false;
      
      console.log('‚úÖ [InventoryModule] D√©truit');
      
    } catch (error) {
      console.error('‚ùå [InventoryModule] Erreur destruction:', error);
    }
  }
  
  // === üêõ DEBUG ===
  
  debugInfo() {
    return {
      initialized: this.uiManagerState.initialized,
      visible: this.uiManagerState.visible,
      enabled: this.uiManagerState.enabled,
      hasSystem: !!this.system,
      hasIcon: !!this.icon,
      hasUI: !!this.ui,
      iconElement: this.icon ? !!this.icon.iconElement : false,
      uiVisible: this.ui ? this.ui.isVisible : false,
      canOpen: this.canOpenInventory(),
      registeredInUIManager: !!(window.uiManager?.registeredIcons?.has('inventory')),
      components: {
        system: this.system?.constructor?.name || 'none',
        icon: this.icon?.constructor?.name || 'none',
        ui: this.ui?.constructor?.name || 'none'
      }
    };
  }
}

// === üè≠ FACTORY POUR UIMANAGER ===

/**
 * Factory function pour cr√©er le module Inventory
 * Compatible avec UIManager
 */
export async function createInventoryModule(gameRoom, scene) {
  try {
    console.log('üè≠ [InventoryFactory] Cr√©ation module Inventory...');
    
    const inventoryModule = new InventoryModule(gameRoom, scene);
    await inventoryModule.init();
    
    console.log('‚úÖ [InventoryFactory] Module cr√©√© avec succ√®s');
    return inventoryModule;
    
  } catch (error) {
    console.error('‚ùå [InventoryFactory] Erreur cr√©ation module Inventory:', error);
    throw error;
  }
}

// === üìã CONFIGURATION POUR UIMANAGER ===

export const INVENTORY_MODULE_CONFIG = {
  id: 'inventory',
  factory: () => createInventoryModule(window.currentGameRoom, window.game?.scene?.getScenes(true)[0]),
  
  defaultState: {
    visible: true,     // Ic√¥ne visible par d√©faut
    enabled: true,     // Module activ√©
    initialized: false
  },
  
  priority: 100,
  critical: true,     // Module critique (inventaire est essentiel)
  
  layout: {
    type: 'icon',
    anchor: 'bottom-right',
    order: 0,           // Premier (position la plus √† droite)
    spacing: 10
  },
  
  responsive: {
    mobile: { 
      scale: 0.8,
      position: { right: '15px', bottom: '15px' }
    },
    tablet: { 
      scale: 0.9 
    },
    desktop: { 
      scale: 1.0 
    }
  },
  
  groups: ['ui-icons', 'inventory-management'],
  
  animations: {
    show: { type: 'fadeIn', duration: 300, easing: 'ease-out' },
    hide: { type: 'fadeOut', duration: 200, easing: 'ease-in' },
    enable: { type: 'pulse', duration: 150 },
    disable: { type: 'grayscale', duration: 200 }
  },
  
  metadata: {
    name: 'Inventory Manager',
    description: 'Complete inventory management system',
    version: '1.0.0',
    category: 'Inventory Management'
  }
};

// === üîó INT√âGRATION AVEC UIMANAGER ===

/**
 * Enregistrer le module Inventory dans UIManager
 */
export async function registerInventoryModule(uiManager) {
  try {
    await uiManager.registerModule('inventory', INVENTORY_MODULE_CONFIG);
    console.log('‚úÖ [InventoryIntegration] Module enregistr√© dans UIManager');
    return true;
  } catch (error) {
    console.error('‚ùå [InventoryIntegration] Erreur enregistrement:', error);
    throw error;
  }
}

/**
 * Initialiser et connecter le module Inventory
 */
export async function initializeInventoryModule(uiManager) {
  try {
    // Enregistrer le module
    await registerInventoryModule(uiManager);
    
    // Initialiser le module
    const inventoryInstance = await uiManager.initializeModule('inventory');
    
    // Setup des raccourcis clavier
    setupInventoryKeyboardShortcuts(inventoryInstance);
    
    // Setup des √©v√©nements globaux
    setupInventoryGlobalEvents(inventoryInstance);
    
    console.log('‚úÖ [InventoryIntegration] Module initialis√© et connect√©');
    return inventoryInstance;
    
  } catch (error) {
    console.error('‚ùå [InventoryIntegration] Erreur initialisation:', error);
    throw error;
  }
}

// === ‚å®Ô∏è RACCOURCIS CLAVIER ===

function setupInventoryKeyboardShortcuts(inventoryInstance) {
  console.log('‚å®Ô∏è [InventoryIntegration] Configuration raccourcis clavier...');
  
  document.addEventListener('keydown', (e) => {
    // Ne pas traiter si on ne peut pas interagir
    if (!inventoryInstance.canOpenInventory()) return;
    
    // Touche I pour ouvrir/fermer Inventory
    if (e.key.toLowerCase() === 'i' && 
        !e.target.matches('input, textarea, [contenteditable]') &&
        !e.ctrlKey && !e.altKey && !e.metaKey) {
      
      e.preventDefault();
      inventoryInstance.toggle();
    }
    
    // Touche B pour ouvrir directement les Pok√© Balls
    if (e.key.toLowerCase() === 'b' && 
        !e.target.matches('input, textarea, [contenteditable]') &&
        !e.ctrlKey && !e.altKey && !e.metaKey) {
      
      e.preventDefault();
      inventoryInstance.openToPocket('balls');
    }
    
    // Touche M pour ouvrir directement les soins
    if (e.key.toLowerCase() === 'm' && 
        !e.target.matches('input, textarea, [contenteditable]') &&
        !e.ctrlKey && !e.altKey && !e.metaKey) {
      
      e.preventDefault();
      inventoryInstance.openToPocket('medicine');
    }
  });
  
  console.log('‚úÖ [InventoryIntegration] Raccourcis configur√©s (I, B, M)');
}

// === üåê √âV√âNEMENTS GLOBAUX ===

function setupInventoryGlobalEvents(inventoryInstance) {
  console.log('üåê [InventoryIntegration] Configuration √©v√©nements globaux...');
  
  // √âv√©nement: Objet ramass√©
  window.addEventListener('itemPickup', (event) => {
    if (inventoryInstance.system) {
      inventoryInstance.system.onItemPickup(event.detail.itemId, event.detail.quantity);
    }
  });
  
  // √âv√©nement: Combat commenc√©
  window.addEventListener('battleStarted', () => {
    if (inventoryInstance.ui && inventoryInstance.ui.isVisible) {
      inventoryInstance.ui.hide();
    }
  });
  
  // √âv√©nement: Entr√©e dans un Centre Pok√©mon
  window.addEventListener('pokemonCenterEntered', () => {
    if (inventoryInstance.system) {
      inventoryInstance.requestInventoryData(); // Refresh data
    }
  });
  
  // √âv√©nement: Inventaire plein
  window.addEventListener('inventoryFull', (event) => {
    if (inventoryInstance.system) {
      inventoryInstance.system.onInventoryFull(event.detail.pocketName);
    }
  });
  
  console.log('‚úÖ [InventoryIntegration] √âv√©nements globaux configur√©s');
}

// === üí° UTILISATION SIMPLE ===

/**
 * Fonction d'utilisation simple pour int√©grer Inventory dans un projet
 */
export async function setupInventorySystem(uiManager) {
  try {
    // Initialiser le module
    const inventoryInstance = await initializeInventoryModule(uiManager);
    
    // Exposer globalement pour compatibilit√©
    window.inventorySystem = inventoryInstance.system;
    window.inventorySystemGlobal = inventoryInstance;
    window.toggleInventory = () => inventoryInstance.toggle();
    window.openInventory = () => inventoryInstance.openInventory();
    window.closeInventory = () => inventoryInstance.closeInventory();
    
    console.log('‚úÖ [InventorySetup] Syst√®me Inventory configur√© et expos√© globalement');
    return inventoryInstance;
    
  } catch (error) {
    console.error('‚ùå [InventorySetup] Erreur configuration:', error);
    throw error;
  }
}

// === üìã EXPORT PAR D√âFAUT ===

export default InventoryModule;

console.log(`
üéí === MODULE INVENTORY UNIFI√â AVEC UIMANAGER ===

‚úÖ ARCHITECTURE:
‚Ä¢ InventoryModule ‚Üí Orchestrateur UIManager
‚Ä¢ InventorySystem ‚Üí Business logic existante
‚Ä¢ InventoryIcon ‚Üí Ic√¥ne UI existante
‚Ä¢ InventoryUI ‚Üí Interface existante

üéõÔ∏è API UIMANAGER:
‚Ä¢ show() ‚Üí Affiche l'ic√¥ne
‚Ä¢ hide() ‚Üí Cache l'ic√¥ne + interface
‚Ä¢ setEnabled(bool) ‚Üí Active/d√©sactive
‚Ä¢ getUIManagerState() ‚Üí √âtat complet

üìç POSITIONNEMENT AUTOMATIQUE:
‚Ä¢ registerWithUIManager() ‚Üí Auto-enregistrement
‚Ä¢ Position bottom-right calcul√©e automatiquement
‚Ä¢ Ordre 0 = position la plus √† droite
‚Ä¢ Espacement 10px avec autres ic√¥nes

üì¶ API PUBLIQUE:
‚Ä¢ toggle() ‚Üí Ouvre/ferme l'interface
‚Ä¢ openToPocket(name) ‚Üí Ouvre poche sp√©cifique
‚Ä¢ hasItem(id) ‚Üí V√©rifie possession
‚Ä¢ useItem(id) ‚Üí Utilise un objet

‚å®Ô∏è RACCOURCIS:
‚Ä¢ I ‚Üí Toggle inventaire
‚Ä¢ B ‚Üí Ouvre Pok√© Balls
‚Ä¢ M ‚Üí Ouvre soins

üîó INT√âGRATION:
‚Ä¢ Compatible avec TeamModule
‚Ä¢ Position order: 0 (plus √† droite)
‚Ä¢ Responsive automatique
‚Ä¢ √âv√©nements globaux

üéØ PR√äT POUR UIMANAGER AVEC POSITIONNEMENT !
`);
