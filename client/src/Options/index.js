// Options/index.js - Point d'entr√©e Options standardis√©
// üéõÔ∏è ALIGN√â sur la structure Team/index.js pour coh√©rence
// üìç Point d'entr√©e unique pour toutes les importations Options

import { BaseModule, createModule, generateModuleConfig } from '../core/BaseModule.js';
import { OptionsManager } from './OptionsManager.js';
import { OptionsIcon } from './OptionsIcon.js';
import { OptionsUI } from './OptionsUI.js';

/**
 * Module Options utilisant BaseModule
 * H√©rite de toute la logique UIManager g√©n√©rique
 */
export class OptionsModule extends BaseModule {
  constructor(moduleId, gameRoom, scene, options = {}) {
    // Configuration sp√©cifique Options
    const optionsOptions = {
      singleton: true,           // Options est un singleton
      autoCloseUI: true,         // Fermer UI par d√©faut
      keyboardShortcut: 'Escape', // Touche √âchap pour ouvrir/fermer
      uiManagerConfig: {
        anchor: 'top-right',
        order: 100,              // Position isol√©e (tr√®s √©lev√©e)
        group: 'options-group'   // Groupe s√©par√©
      },
      ...options
    };
    
    super(moduleId || 'options', gameRoom, scene, optionsOptions);
    
    console.log('üéõÔ∏è [OptionsModule] Instance cr√©√©e avec BaseModule');
  }
  
  // === üéØ IMPL√âMENTATION DES M√âTHODES ABSTRAITES ===
  
  /**
   * Initialisation sp√©cifique Options
   */
  async init() {
    console.log('üöÄ [OptionsModule] Initialisation m√©tier Options...');
    
    // Cr√©er le manager (business logic)
    this.manager = new OptionsManager(this.gameRoom, {
      storageKey: 'game_settings',
      autoSave: true,
      autoApply: true,
      onSettingsChange: (settings) => this.handleSettingsChange(settings),
      onLanguageChange: (language) => this.handleLanguageChange(language),
      onAudioChange: (audio) => this.handleAudioChange(audio)
    });
    
    await this.manager.init();
    
    console.log('‚úÖ [OptionsModule] Manager Options initialis√©');
  }
  
  /**
   * Cr√©ation des composants Options
   */
  createComponents() {
    console.log('üîß [OptionsModule] Cr√©ation composants Options...');
    
    // Cr√©er l'ic√¥ne si pas encore fait
    if (!this.icon) {
      this.icon = new OptionsIcon(this.manager, {
        onClick: () => this.handleIconClick(),
        onHover: (hovered) => this.handleIconHover(hovered)
      });
      this.icon.init();
    }
    
    // Cr√©er l'interface si pas encore fait
    if (!this.ui) {
      this.ui = new OptionsUI(this.manager, {
        closeOnEscape: true,
        saveOnClose: true,
        onClose: () => this.handleUIClose(),
        onSettingsApply: (settings) => this.handleSettingsApply(settings),
        onLanguageTest: (language) => this.handleLanguageTest(language)
      });
      // Note: L'init de OptionsUI est async, on le fait dans connectComponents si n√©cessaire
    }
    
    console.log('‚úÖ [OptionsModule] Composants Options cr√©√©s');
  }
  
  /**
   * Connexion des composants Options
   */
  connectComponents() {
    console.log('üîó [OptionsModule] Connexion composants Options...');
    
    // Initialiser UI de mani√®re async si n√©cessaire
    if (this.ui && !this.ui.initialized) {
      this.ui.init().catch(error => {
        console.error('‚ùå [OptionsModule] Erreur init UI:', error);
      });
    }
    
    // Ic√¥ne ‚Üí Interface (clic ouvre l'interface)
    if (this.icon) {
      this.icon.onClick = () => {
        if (this.canOpenUI()) {
          this.ui.toggle();
        } else {
          this.showCannotOpenMessage();
        }
      };
    }
    
    // Manager ‚Üí Ic√¥ne (mise √† jour des changements)
    if (this.manager) {
      this.manager.onSettingsChange = (settings) => {
        if (this.icon) {
          this.icon.setHasChanges(this.manager.isDirtySettings());
        }
        
        // Propager le changement
        this.handleSettingsChange(settings);
      };
    }
    
    // Interface ‚Üí Manager (actions utilisateur)
    if (this.ui) {
      this.ui.onSettingsApply = (settings) => {
        if (this.manager) {
          this.manager.updateSettings(settings);
        }
        this.handleSettingsApply(settings);
      };
    }
    
    console.log('‚úÖ [OptionsModule] Composants Options connect√©s');
  }
  
  // === üìä M√âTHODES SP√âCIFIQUES OPTIONS ===
  
  /**
   * Obtenir la langue courante
   */
  getCurrentLanguage() {
    return this.manager ? this.manager.getCurrentLanguage() : 'en';
  }
  
  /**
   * Changer la langue
   */
  setLanguage(langCode, manual = true) {
    if (this.manager) {
      return this.manager.setLanguage(langCode, manual);
    }
    return false;
  }
  
  /**
   * Obtenir tous les param√®tres
   */
  getAllSettings() {
    return this.manager ? this.manager.getSettings() : {};
  }
  
  /**
   * Reset aux param√®tres par d√©faut
   */
  resetToDefaults() {
    if (this.manager) {
      return this.manager.resetToDefaults();
    }
    return false;
  }
  
  // === üé¨ GESTION √âV√âNEMENTS ===
  
  handleIconClick() {
    console.log('üñ±Ô∏è [OptionsModule] Clic ic√¥ne Options');
    
    if (this.canOpenUI()) {
      this.ui.toggle();
    } else {
      this.showCannotOpenMessage('Options temporairement inaccessibles');
    }
  }
  
  handleIconHover(hovered) {
    // Tooltip g√©r√© par l'ic√¥ne elle-m√™me
  }
  
  handleUIClose() {
    console.log('üö™ [OptionsModule] Fermeture UI Options');
    
    // Auto-save g√©r√© par OptionsUI
    if (this.icon) {
      this.icon.setHasChanges(false); // Plus de changements non sauvegard√©s
    }
  }
  
  handleSettingsChange(settings) {
    console.log('üîß [OptionsModule] Changement param√®tres:', settings);
    
    // Propager aux autres syst√®mes si n√©cessaire
    if (settings.language) {
      // Notifier changement de langue globalement
      document.dispatchEvent(new CustomEvent('languageChanged', {
        detail: { 
          language: this.getCurrentLanguage(),
          settings: settings.language
        }
      }));
    }
  }
  
  handleSettingsApply(settings) {
    console.log('‚úÖ [OptionsModule] Application param√®tres:', settings);
    
    // Feedback utilisateur
    if (typeof window.showGameNotification === 'function') {
      window.showGameNotification('Param√®tres sauvegard√©s !', 'success', {
        duration: 2000
      });
    }
  }
  
  handleLanguageChange(languageData) {
    console.log('üåç [OptionsModule] Changement langue:', languageData);
    
    // Mettre √† jour API globale
    this.updateGlobalLanguageAPI();
  }
  
  handleLanguageTest(language) {
    console.log('üß™ [OptionsModule] Test langue:', language);
    
    // Test g√©r√© par OptionsUI
  }
  
  handleAudioChange(audioData) {
    console.log('üîä [OptionsModule] Changement audio:', audioData);
    
    // Audio g√©r√© par OptionsManager automatiquement
  }
  
  // === üåê API GLOBALE ===
  
  updateGlobalLanguageAPI() {
    // S'assurer que l'API globale retourne la langue actuelle
    const currentLang = this.getCurrentLanguage();
    
    // Mettre √† jour les fonctions globales
    window.getPlayerLanguage = () => currentLang;
    
    console.log(`üåê [OptionsModule] API globale mise √† jour: ${currentLang}`);
  }
  
  // === üìã OVERRIDE STATE POUR INFOS OPTIONS ===
  
  getUIManagerState() {
    const baseState = super.getUIManagerState();
    
    // Ajouter infos sp√©cifiques Options
    return {
      ...baseState,
      currentLanguage: this.getCurrentLanguage(),
      hasUnsavedChanges: this.manager ? this.manager.isDirtySettings() : false,
      moduleType: 'options'
    };
  }
  
  // === ‚å®Ô∏è OVERRIDE RACCOURCI CLAVIER ===
  
  canOpenUI() {
    // Options peut TOUJOURS s'ouvrir (contrairement aux autres modules)
    return this.isEnabled;
  }
  
  showCannotOpenMessage(message = 'Options inaccessibles') {
    if (typeof window.showGameNotification === 'function') {
      window.showGameNotification(message, 'warning', {
        duration: 2000
      });
    }
  }
}

// === üè≠ FACTORY OPTIONS SIMPLIFI√âE ===

/**
 * Factory function pour cr√©er le module Options
 * Utilise la factory g√©n√©rique de BaseModule
 */
export async function createOptionsModule(gameRoom, scene, options = {}) {
  try {
    console.log('üè≠ [OptionsFactory] Cr√©ation module Options avec BaseModule...');
    
    const optionsOptions = {
      singleton: true,
      ...options
    };
    
    const optionsInstance = await createModule(OptionsModule, 'options', gameRoom, scene, optionsOptions);
    
    console.log('‚úÖ [OptionsFactory] Module Options cr√©√© avec succ√®s');
    return optionsInstance;
    
  } catch (error) {
    console.error('‚ùå [OptionsFactory] Erreur cr√©ation module Options:', error);
    throw error;
  }
}

// === üìã CONFIGURATION OPTIONS POUR UIMANAGER ===

export const OPTIONS_MODULE_CONFIG = generateModuleConfig('options', {
  moduleClass: OptionsModule,
  order: 100, // Position isol√©e
  
  options: {
    singleton: true,
    keyboardShortcut: 'Escape',
    autoCloseUI: true
  },
  
  groups: ['options-group'],
  
  metadata: {
    name: 'Options System',
    description: 'Game settings and preferences management',
    version: '1.0.0',
    category: 'System',
    singleton: true,
    alwaysAccessible: true
  },
  
  factory: () => createOptionsModule(
    window.currentGameRoom, 
    window.game?.scene?.getScenes(true)[0]
  )
});

// === üîó INT√âGRATION AVEC UIMANAGER SIMPLIFI√âE ===

/**
 * Enregistrer le module Options dans UIManager
 */
export async function registerOptionsModule(uiManager) {
  try {
    console.log('üìù [OptionsIntegration] Enregistrement Options...');
    
    // V√©rifier si d√©j√† enregistr√©
    if (uiManager.modules && uiManager.modules.has('options')) {
      console.log('‚ÑπÔ∏è [OptionsIntegration] Module d√©j√† enregistr√©');
      return true;
    }
    
    await uiManager.registerModule('options', OPTIONS_MODULE_CONFIG);
    console.log('‚úÖ [OptionsIntegration] Module Options enregistr√©');
    
    return true;
  } catch (error) {
    console.error('‚ùå [OptionsIntegration] Erreur enregistrement:', error);
    throw error;
  }
}

/**
 * Initialiser et connecter le module Options
 */
export async function initializeOptionsModule(uiManager) {
  try {
    console.log('üöÄ [OptionsIntegration] Initialisation Options...');
    
    // Enregistrer le module
    await registerOptionsModule(uiManager);
    
    // V√©rifier si d√©j√† initialis√© (singleton)
    let optionsInstance = OptionsModule.getInstance('options');
    
    if (!optionsInstance || !optionsInstance.uiManagerState.initialized) {
      // Initialiser le module
      optionsInstance = await uiManager.initializeModule('options');
    } else {
      console.log('‚ÑπÔ∏è [OptionsIntegration] Instance d√©j√† initialis√©e');
      
      // Connecter √† UIManager si pas encore fait
      optionsInstance.connectUIManager(uiManager);
    }
    
    // Setup des √©v√©nements globaux Options
    setupOptionsGlobalEvents(optionsInstance);
    
    console.log('‚úÖ [OptionsIntegration] Initialisation Options termin√©e');
    return optionsInstance;
    
  } catch (error) {
    console.error('‚ùå [OptionsIntegration] Erreur initialisation:', error);
    throw error;
  }
}

// === üåê √âV√âNEMENTS GLOBAUX OPTIONS ===

function setupOptionsGlobalEvents(optionsInstance) {
  // √âviter double setup
  if (window._optionsEventsSetup) {
    console.log('‚ÑπÔ∏è [OptionsEvents] √âv√©nements d√©j√† configur√©s');
    return;
  }
  
  // √âv√©nement: Changement de langue
  window.addEventListener('languageChanged', (event) => {
    const { language } = event.detail;
    console.log(`üåç [OptionsEvents] Langue chang√©e globalement: ${language}`);
    
    // Propager aux autres syst√®mes
    document.dispatchEvent(new CustomEvent('gameLanguageChanged', {
      detail: { language, source: 'options' }
    }));
  });
  
  // √âv√©nement: Touche √âchap globale
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && 
        !e.target.matches('input, textarea, [contenteditable]') &&
        !e.ctrlKey && !e.altKey && !e.metaKey) {
      
      // V√©rifier si pas dans un dialogue critique
      const dialogueBox = document.querySelector('#dialogue-box');
      const dialogueVisible = dialogueBox && 
        dialogueBox.style.display !== 'none' && 
        !dialogueBox.hidden;
      
      if (!dialogueVisible && optionsInstance.canOpenUI()) {
        e.preventDefault();
        
        if (optionsInstance.ui && optionsInstance.ui.isVisible) {
          optionsInstance.ui.hide();
        } else {
          optionsInstance.ui.show();
        }
      }
    }
  });
  
  window._optionsEventsSetup = true;
  console.log('üåê [OptionsEvents] √âv√©nements Options configur√©s');
}

// === üí° UTILISATION SIMPLE ===

/**
 * Fonction d'utilisation simple pour int√©grer Options dans un projet
 */
export async function setupOptionsSystem(uiManager) {
  try {
    console.log('üîß [OptionsSetup] Configuration syst√®me Options avec BaseModule...');
    
    // Initialiser le module
    const optionsInstance = await initializeOptionsModule(uiManager);
    
    // Exposer globalement pour compatibilit√©
    if (!window.optionsSystem) {
      window.optionsSystem = optionsInstance;
      window.optionsSystemGlobal = optionsInstance;
      window.toggleOptions = () => optionsInstance.toggleUI();
      window.openOptions = () => optionsInstance.open();
      window.closeOptions = () => optionsInstance.close();
      window.forceCloseOptions = () => optionsInstance.forceCloseUI();
      
      // API sp√©cifique Options
      window.getPlayerLanguage = () => optionsInstance.getCurrentLanguage();
      window.setPlayerLanguage = (lang, manual = true) => optionsInstance.setLanguage(lang, manual);
      window.getGameSettings = () => optionsInstance.getAllSettings();
      window.resetGameSettings = () => optionsInstance.resetToDefaults();
      
      console.log('üåê [OptionsSetup] Fonctions globales Options expos√©es');
    }
    
    console.log('‚úÖ [OptionsSetup] Syst√®me Options configur√© avec BaseModule');
    return optionsInstance;
    
  } catch (error) {
    console.error('‚ùå [OptionsSetup] Erreur configuration:', error);
    throw error;
  }
}

// === üîç UTILIT√âS DE DEBUG OPTIONS ===

export function debugOptionsModule() {
  const { debugModule } = require('../core/BaseModule.js');
  return debugModule('options', OptionsModule);
}

export function fixOptionsModule() {
  console.log('üîß [OptionsFix] R√©paration module Options...');
  
  try {
    const instance = OptionsModule.getInstance('options');
    
    if (instance) {
      // Force fermeture UI via BaseModule
      instance.forceCloseUI();
      
      console.log('‚úÖ [OptionsFix] Module Options r√©par√©');
      return true;
    } else {
      console.log('‚ÑπÔ∏è [OptionsFix] Aucune instance √† r√©parer');
      return false;
    }
    
  } catch (error) {
    console.error('‚ùå [OptionsFix] Erreur r√©paration:', error);
    return false;
  }
}

// === üìã EXPORT PAR D√âFAUT ===

export default OptionsModule;

// === üéØ FONCTIONS D'INITIALISATION RAPIDE ===

/**
 * Fonction d'initialisation rapide pour tests
 */
export async function quickInitializeOptions() {
  try {
    console.log('‚ö° [OptionsQuick] Initialisation rapide...');
    
    const optionsModule = await createOptionsModule(
      window.currentGameRoom,
      window.game?.scene?.getScenes(true)[0]
    );
    
    // Setup API globale imm√©diatement
    window.optionsSystemGlobal = optionsModule;
    window.getPlayerLanguage = () => optionsModule.getCurrentLanguage();
    window.setPlayerLanguage = (lang, manual = true) => optionsModule.setLanguage(lang, manual);
    
    console.log('‚úÖ [OptionsQuick] Options initialis√© rapidement');
    return optionsModule;
    
  } catch (error) {
    console.error('‚ùå [OptionsQuick] Erreur initialisation rapide:', error);
    throw error;
  }
}

console.log(`
üéõÔ∏è === OPTIONS MODULE AVEC BASEMODULE ===

üéØ NOUVELLES FONCTIONNALIT√âS:
‚Ä¢ BaseModule - logique UIManager mutualis√©e  
‚Ä¢ Code standardis√© - consistent avec Team/Quest
‚Ä¢ Patterns uniformes - architecture coh√©rente
‚Ä¢ Singleton int√©gr√© - via BaseModule

üìç AVANTAGES BASEMODULE:
‚Ä¢ connectUIManager() g√©n√©rique
‚Ä¢ forceCloseUI() standardis√©
‚Ä¢ Gestion √©tat UIManager uniforme
‚Ä¢ Raccourcis clavier automatiques (√âchap)

üîß M√âTHODES H√âRIT√âES:
‚Ä¢ show(), hide(), setEnabled() - standards
‚Ä¢ connectUIManager() - connexion s√©curis√©e
‚Ä¢ getUIManagerState() - √©tat complet
‚Ä¢ forceCloseUI() - fermeture forc√©e

üéØ SP√âCIFICIT√âS OPTIONS:
‚Ä¢ getCurrentLanguage() - langue active
‚Ä¢ setLanguage() - changement langue
‚Ä¢ getAllSettings() - tous param√®tres
‚Ä¢ API globale window.getPlayerLanguage()

‚å®Ô∏è RACCOURCI CLAVIER:
‚Ä¢ √âchap ouvre/ferme Options PARTOUT
‚Ä¢ Accessible m√™me en bataille/dialogue
‚Ä¢ canOpenUI() toujours true

‚úÖ OPTIONS STANDARDIS√â AVEC BASEMODULE !
`);
